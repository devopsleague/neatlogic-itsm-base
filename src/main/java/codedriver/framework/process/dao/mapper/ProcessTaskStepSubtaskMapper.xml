<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="codedriver.framework.process.dao.mapper.ProcessTaskStepSubtaskMapper">

	<resultMap id="processTaskStepSubtaskMap" type="codedriver.framework.process.dto.ProcessTaskStepSubtaskVo">
		<result column="processTaskId" property="processTaskId" />
		<result column="processTaskStepId" property="processTaskStepId" />
		<result column="id" property="id" />
		<result column="status" property="status" />
		<result column="userUuid" property="userUuid" />
		<result column="userName" property="userName" />
		<result column="targetTime" property="targetTime" />
		<result column="createTime" property="createTime" />
		<result column="startTime" property="startTime" />
		<result column="endTime" property="endTime" />
		<result column="cancelUser" property="cancelUser" />
		<result column="cancelTime" property="cancelTime" />
		<result column="majorUser" property="majorUser" />
		<!--<result column="activeTime" property="activeTime" />-->
		<association property="ownerVo" javaType="codedriver.framework.dto.UserVo">
			<result property="uuid" column="ownerUuid" />
			<result property="userName" column="ownerName" />
			<result property="userInfo" column="ownerInfo" />
			<result property="vipLevel" column="ownerVipLevel" />
			<result property="pinyin" column="ownerPinyin" />
		</association>
	</resultMap>

	<select id="getProcessTaskStepSubtaskById" parameterType="java.lang.Long" resultMap="processTaskStepSubtaskMap">
	SELECT 
	  a.`processtask_id` AS processTaskId,
	  a.`processtask_step_id` AS processTaskStepId,
	  a.`id`,
	  a.`owner` as ownerUuid,
	  a.`status`,
	  a.`user_uuid` AS userUuid,
	  (SELECT `user_name` FROM `user` WHERE `uuid` = a.`user_uuid`) AS userName,
	  a.`target_time` AS targetTime,
	  a.`create_time` AS createTime,
	  a.`start_time` AS startTime,
	  a.`end_time` AS endTime,
	  a.`cancel_user` AS cancelUser,
	  a.`cancel_time` AS cancelTime,
	  b.`user_uuid` AS majorUser
	FROM `processtask_step_subtask` a
	JOIN `processtask_step_user` b ON b.`processtask_step_id`=a.`processtask_step_id` AND b.`user_type`='major'
	WHERE a.`id` = #{id}
	</select>
	
	<select id="getProcessTaskStepSubtaskListByProcessTaskStepId" parameterType="java.lang.Long" resultMap="processTaskStepSubtaskMap">
	SELECT 
	  a.`processtask_id` AS processTaskId,
	  a.`processtask_step_id` AS processTaskStepId,
	  a.`id`,
	  a.`owner` as ownerUuid,
	  (SELECT `user_name` FROM `user` WHERE `uuid` = `owner`) AS ownerName,
	  (SELECT `user_info` FROM `user` WHERE `uuid` = `owner`) AS ownerInfo,
	  (SELECT `vip_level` FROM `user` WHERE `uuid` = `owner`) AS ownerVipLevel,
	  (SELECT `pinyin` FROM `user` WHERE `uuid` = `owner`) AS ownerPinyin,
	  a.`status`,
	  a.`user_uuid` AS userUuid,
	  (SELECT `user_name` FROM `user` WHERE `uuid` = a.`user_uuid`) AS userName,
	  a.`target_time` AS targetTime,
	  a.`create_time` AS createTime,
	  a.`start_time` AS startTime,
	  a.`end_time` AS endTime,
	  a.`cancel_user` AS cancelUser,
	  a.`cancel_time` AS cancelTime,
	  b.`user_uuid` AS majorUser
	FROM `processtask_step_subtask` a
	JOIN `processtask_step_user` b ON b.`processtask_step_id`=a.`processtask_step_id` AND b.`user_type`='major'
	WHERE a.`processtask_step_id` = #{value}
	</select>

	<resultMap id="processTaskStepSubtaskContentMap" type="codedriver.framework.process.dto.ProcessTaskStepSubtaskContentVo">
		<result column="id" property="id" />
		<result column="processTaskStepSubtaskId" property="processTaskStepSubtaskId" />
		<result column="contentHash" property="contentHash" />
		<result column="content" property="content" />
		<result column="action" property="action" />
		<result column="fcd" property="fcd" />
		<result column="lcd" property="lcd" />
		<association property="fcuVo" javaType="codedriver.framework.dto.UserVo">
			<result property="uuid" column="fcuUuid" />
			<result property="userName" column="fcuName" />
			<result property="userInfo" column="fcuInfo" />
			<result property="vipLevel" column="fcuVipLevel" />
			<result property="pinyin" column="fcuPinyin" />
		</association>
		<association property="lcuVo" javaType="codedriver.framework.dto.UserVo">
			<result property="uuid" column="lcuUuid" />
			<result property="userName" column="lcuName" />
			<result property="userInfo" column="lcuInfo" />
			<result property="vipLevel" column="lcuVipLevel" />
			<result property="pinyin" column="lcuPinyin" />
		</association>
	</resultMap>
	
	<select id="getProcessTaskStepSubtaskContentBySubtaskId" parameterType="java.lang.Long" resultMap="processTaskStepSubtaskContentMap">
	SELECT 
	  a.`id`,
	  a.`processtask_step_subtask_id` AS processTaskStepSubtaskId,
	  a.`content_hash` AS contentHash,
	  b.`content`,
	  a.`action`,
	  a.`fcd`,
	  a.`fcu` as fcuUuid,
	  (SELECT `user_info` from `user` WHERE `uuid` = a.`fcu`) as fcuInfo,
	  (SELECT `vip_level` from `user` WHERE `uuid` = a.`fcu`) as fcuVipLevel,
	  (SELECT `pinyin` from `user` WHERE `uuid` = a.`fcu`) as fcuPinyin,
	  c.`user_name` AS fcuName,
	  a.`lcd`,
	  a.`lcu` as lcuUuid,
	  (SELECT `user_info` from `user` WHERE `uuid` = a.`lcu`) as lcuInfo,
	  (SELECT `vip_level` from `user` WHERE `uuid` = a.`lcu`) as lcuVipLevel,
	  (SELECT `pinyin` from `user` WHERE `uuid` = a.`lcu`) as lcuPinyin
	FROM `processtask_step_subtask_content` a
	JOIN `processtask_content` b on b.`hash` = a.`content_hash`
	LEFT JOIN `user` c ON c.`uuid` = a.`fcu`
	WHERE a.`processtask_step_subtask_id` = #{processTaskStepSubtaskId}
	</select>
	
	<insert id="insertProcessTaskStepSubtask" parameterType="codedriver.framework.process.dto.ProcessTaskStepSubtaskVo">
	<selectKey keyProperty="id" resultType="java.lang.Long" order="AFTER">
			select LAST_INSERT_ID() as id
	</selectKey>
	INSERT INTO `processtask_step_subtask` (
	  `processtask_id`,
	  `processtask_step_id`,
	  `id`,
	  `owner`,
	  `status`,
	  `user_uuid`,
	  `target_time`,
	  `create_time`,
	  `start_time`
	) 
	VALUES
	  (
	    #{processTaskId},
	    #{processTaskStepId},
	    #{id},
	    #{ownerVo.uuid},
	    #{status},
	    #{userUuid},
	    #{targetTime},
	    NOW(3),
	    NOW(3)
	  ) 
	</insert>

	<insert id="insertProcessTaskStepSubtaskContent" parameterType="codedriver.framework.process.dto.ProcessTaskStepSubtaskContentVo">
	INSERT INTO `processtask_step_subtask_content` (
	  `processtask_step_subtask_id`,
	  `content_hash`,
	  `action`,
	  `fcd`,
	  `fcu`,
	  `lcd`,
	  `lcu`
	) 
	VALUES
	  (
	    #{processTaskStepSubtaskId},
	    #{contentHash},
	    #{action},
	    NOW(3),
	    #{fcuVo.uuid},
	    NOW(3),
	    #{fcuVo.uuid}
	  ) 
	</insert>
	
	<update id="updateProcessTaskStepSubtaskStatus" parameterType="codedriver.framework.process.dto.ProcessTaskStepSubtaskVo">
	UPDATE 
	  `processtask_step_subtask` 
	SET
  	<if test="status == 'running'">
  		`user_uuid` = #{userUuid},
  		`target_time` = #{targetTime},
  		`start_time` = NOW(3),
  		`end_time` = NULL,
  	</if>
  	<if test="status == 'succeed'">
  		`end_time` = NOW(3),
  	</if>
  	<if test="status == 'canceled'">
  		`cancel_user` = #{cancelUser},
  		`cancel_time` = NOW(3),
  	</if>
	  `status` = #{status}
	WHERE `id` = #{id} 
	</update>

	<update id="updateProcessTaskStepSubtaskContent" parameterType="codedriver.framework.process.dto.ProcessTaskStepSubtaskContentVo">
	UPDATE `processtask_step_subtask_content` 
	SET `content_hash` = #{contentHash},
	  `lcd` = NOW(3),
	  `lcu` = #{lcuVo.uuid}
	<where>
		<if test="id != null">
		AND `id` = #{id}
		</if>
		<if test="processTaskStepSubtaskId != null">
		AND `processtask_step_subtask_id` = #{processTaskStepSubtaskId}
		</if>
		<if test="action != null and action != ''">
		AND `action` = #{action}
		</if>
	</where>
	</update>

</mapper>
