<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="codedriver.framework.process.dao.mapper.FormMapper">

	<select id="getActionFormVersionByFormUuid" parameterType="java.lang.String" resultType="codedriver.framework.process.dto.FormVersionVo">
		SELECT
		a.`uuid`,
		a.`version`,
		a.`is_active` AS isActive,
		a.`form_uuid` AS formUuid,
		a.`form_config` AS formConfig,
		b.`name` AS formName
		FROM
		`form_version` a
		JOIN `form` b
		ON a.`form_uuid` = b.`uuid`
		WHERE a.`form_uuid` = #{value}
		AND a.`is_active` = 1
	</select>

	<select id="searchFormList" parameterType="codedriver.framework.process.dto.FormVo" resultType="codedriver.framework.process.dto.FormVo">
		SELECT
		f.`uuid`,
		f.`name`,
		f.`is_active` AS isActive,
		fv.`version` AS currentVersion,
		fv.`uuid` AS currentVersionUuid
		FROM `form` f
		JOIN `form_version` fv ON fv.`form_uuid`=f.`uuid` AND fv.`is_active` = 1
		WHERE 1=1
		<if test="isActive != null">
			AND f.`is_active` = #{isActive}
		</if>
		<if test="keyword != null and keyword != ''">
			AND f.`name` LIKE CONCAT('%', #{keyword},'%') 
		</if>
		ORDER BY f.`fcd` DESC
		<if test="needPage">
			LIMIT #{startNum}, #{pageSize}
		</if>
	</select>

	<select id="searchFormListForSelect" parameterType="codedriver.framework.process.dto.FormVo" resultType="codedriver.framework.common.dto.ValueTextVo">
		SELECT
		f.`uuid` as `value`,
		f.`name` as `text`
		FROM `form` f
		WHERE 1=1
		<if test="isActive != null">
			AND f.`is_active` = #{isActive}
		</if>
		<if test="keyword != null and keyword != ''">
			AND f.`name` LIKE CONCAT('%', #{keyword},'%')
		</if>
		ORDER BY f.`fcd` DESC
		<if test="needPage">
			LIMIT #{startNum}, #{pageSize}
		</if>
	</select>

	<select id="searchFormCount" parameterType="codedriver.framework.process.dto.FormVo" resultType="int">
		SELECT
		COUNT(f.`uuid`)
		FROM
		`form` f
		JOIN `form_version` fv ON fv.`form_uuid`=f.`uuid` AND fv.`is_active` = 1
		WHERE 1=1
		<if test="isActive != null">
			AND f.`is_active` = #{isActive}
		</if>
		<if test="keyword != null and keyword != ''">
			AND f.`name` LIKE CONCAT('%', #{keyword},'%') 
		</if>
	</select>

	<select id="getMaxVersionByFormUuid" parameterType="java.lang.String" resultType="java.lang.Integer">
		SELECT max(version) FROM `form_version` WHERE form_uuid = #{value} FOR UPDATE
	</select>

	<select id="getFormVersionByUuid" parameterType="java.lang.String" resultType="codedriver.framework.process.dto.FormVersionVo">
		SELECT
		`uuid`,
		`version`,
		`is_active` AS isActive,
		`form_uuid` AS formUuid,
		`form_config` AS formConfig,
		`lcu` AS editor,
		`lcd` AS editTime
		FROM
		`form_version`
		WHERE
		`uuid` = #{value}
	</select>

	<select id="getFormByUuid" parameterType="java.lang.String" resultType="codedriver.framework.process.dto.FormVo">
		SELECT
		`uuid`,
		`name`,
		`is_active` AS isActive
		FROM
		`form`
		WHERE `uuid` = #{value}
	</select>

	<select id="getFormVersionByFormUuid" parameterType="java.lang.String" resultType="codedriver.framework.process.dto.FormVersionVo">
		SELECT
		`uuid`,
		`version`,
		`is_active` AS isActive,
		`form_uuid` AS formUuid,
		`form_config` AS formConfig,
		`lcu` AS editor,
		`lcd` AS editTime
		FROM
		`form_version`
		WHERE
		form_uuid = #{value}
		ORDER BY `version`
	</select>

	<select id="getFormVersionSimpleByFormUuid" parameterType="java.lang.String" resultType="codedriver.framework.process.dto.FormVersionVo">
	SELECT
		`uuid`,
		`version`,
		`is_active` AS isActive
		FROM
		`form_version`
		WHERE
		form_uuid = #{value}
		ORDER BY `version`
	</select>
	
	<select id="getFormReferenceCount" parameterType="java.lang.String" resultType="int">
	SELECT 
	count(p.`uuid`)
	FROM `process` p 
	JOIN `process_form` pf ON pf.`process_uuid` = p.`uuid` AND pf.`form_uuid` = #{formUuid}
	</select>
	
	<select id="getFormReferenceList" parameterType="codedriver.framework.process.dto.ProcessFormVo" resultType="codedriver.framework.process.dto.ProcessVo">
	SELECT 
	p.`uuid`,
	p.`name` 
	FROM `process` p 
	JOIN `process_form` pf ON pf.`process_uuid` = p.`uuid` AND pf.`form_uuid` = #{formUuid}
	<if test="needPage">
	LIMIT #{startNum}, #{pageSize}
	</if>
	</select>
	
	<select id="checkFormIsExists" parameterType="java.lang.String" resultType="int">
	SELECT COUNT(`uuid`) FROM `form` WHERE `uuid` = #{uuid}
	</select>
	
	<select id="checkFormNameIsRepeat" parameterType="codedriver.framework.process.dto.FormVo" resultType="int">
	SELECT COUNT(`uuid`) FROM `form` WHERE `name` = #{name} and `uuid` != #{uuid}
	</select>
	
	<select id="checkFormVersionIsExists" parameterType="java.lang.String" resultType="int">
	SELECT COUNT(`uuid`) FROM `form_version` WHERE `uuid` = #{uuid}
	</select>
	
	<select id="getFormAttributeList" parameterType="codedriver.framework.process.dto.FormAttributeVo" resultType="codedriver.framework.process.dto.FormAttributeVo">
	SELECT
	 a.`form_uuid` AS formUuid,
	 a.`formversion_uuid` as formversionUuid,
	 a.`uuid`,
	 a.`label`,
	 a.`type`,
	 a.`handler`,
	 a.`config`,
	 a.`data`
	FROM `form_attribute` a
	JOIN `form_version` b ON b.`uuid`=a.`formversion_uuid` AND b.`is_active` = 1
	WHERE a.`form_uuid` = #{formUuid}
	<if test="formVersionUuid != null">
		AND a.`formversion_uuid` = #{formVersionUuid}
	</if>
	</select>
	
	<select id="getFormAttributeListByChannelUuidList" parameterType="java.util.List" resultType="codedriver.framework.process.dto.FormAttributeVo">
		SELECT 
		 fa.`form_uuid` AS formUuid,
		 fa.`formversion_uuid` AS formversionUuid,
		 fa.`uuid`,
		 fa.`label`,
		 fa.`type`,
		 fa.`handler`,
		 fa.`config`,
		 fa.`data`
		FROM `channel_process` cp
		JOIN `process_form` pf ON cp.`process_uuid` = pf.`process_uuid`
		JOIN `form_version` fv ON pf.`form_uuid` = fv.`form_uuid` AND fv.`is_active` =1 
		JOIN `form_attribute` fa ON fv.`form_uuid` = fa.`form_uuid` AND fv.`uuid` = fa.`formversion_uuid`
		<where>
			 cp.`channel_uuid` IN 
			<if test="channelUuidList != null and channelUuidList.size() > 0 ">
				<foreach collection="channelUuidList" item="item" open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
		</where>
	</select>
	
	<update id="updateFormVersion" parameterType="codedriver.framework.process.dto.FormVersionVo">
		UPDATE
		`form_version`
		SET
		<if test="isActive != null">
		`is_active` = #{isActive},
		</if>
		<if test="formConfig != null and formConfig != ''">
		`form_config` = #{formConfig},
		</if>
		`lcd` = NOW(),
		`lcu` = #{editor}
		WHERE `uuid` = #{uuid}
	</update>

	<update id="resetFormVersionIsActiveByFormUuid" parameterType="java.lang.String">
		UPDATE `form_version`
		SET
		`is_active` = 0
		WHERE
		`form_uuid` = #{value}
	</update>
	
	<update id="updateForm" parameterType="codedriver.framework.process.dto.FormVo">
	UPDATE `form` SET 
	<if test="isActive != null">
	`is_active` = #{isActive},
	</if>
	<if test="name != null and name != ''">
	`name`=#{name}, 
	</if>
	`uuid` = #{uuid} 
	WHERE `uuid` = #{uuid};
	</update>

	<insert id="insertForm" parameterType="codedriver.framework.process.dto.FormVo">
		INSERT INTO `form` (
		`uuid`,
		`name`,
		`is_active`,
		`fcd`
		)
		VALUES
		(
		#{uuid},
		#{name},
		#{isActive},
		now()
		)
	</insert>

	<insert id="insertFormVersion" parameterType="codedriver.framework.process.dto.FormVersionVo">
		INSERT INTO `form_version` (
		`uuid`,
		`version`,
		`is_active`,
		`form_uuid`,
		`form_config`,
		`fcd`,
		`fcu`
		)
		VALUES
		(
		#{uuid},
		#{version},
		#{isActive},
		#{formUuid},
		#{formConfig},
		NOW(),
		#{editor}
		)
	</insert>

	<insert id="insertFormAttribute" parameterType="codedriver.framework.process.dto.FormAttributeVo">
		INSERT INTO `form_attribute` (
		  `form_uuid`,
		  `formversion_uuid`,
		  `uuid`,
		  `label`,
		  `type`,
		  `handler`,
		  `config`,
		  `data`
		) 
		VALUES
		  (
		    #{formUuid},
		    #{formVersionUuid},
		    #{uuid},
		    #{label},
		    #{type},
		    #{handler},
		    #{config},
		    #{data}
		  )
	</insert>

	<delete id="deleteFormAttributeByFormUuid" parameterType="java.lang.String">
		DELETE
		FROM
		`form_attribute`
		WHERE `form_uuid` = #{value}
	</delete>

	<delete id="deleteFormByUuid" parameterType="java.lang.String">
	DELETE FROM `form` WHERE `uuid` = #{uuid}
	</delete>

	<delete id="deleteFormVersionByFormUuid" parameterType="java.lang.String">
	DELETE FROM `form_version` WHERE `form_uuid` = #{formUuid}
	</delete>

	<delete id="deleteProcessFormByFormUuid" parameterType="java.lang.String">
	DELETE FROM `process_form` WHERE `form_uuid` = #{formUuid}
	</delete>
	
	<delete id="deleteFormVersionByUuid" parameterType="java.lang.String">
	DELETE FROM `form_version` WHERE `uuid` = #{uuid}
	</delete>
	
	<delete id="deleteProcessMatrixFormComponentByFormVersionUuid" parameterType="java.lang.String">
	DELETE FROM `process_matrix_form_component` WHERE `form_version_uuid` = #{formVersionUuid} 
	</delete>
</mapper>
