<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="codedriver.framework.process.dao.mapper.MatrixMapper">
	<resultMap id="matrixMap" type="codedriver.framework.process.dto.ProcessMatrixVo">
		<id property="uuid" column="uuid"/>
		<result property="id" column="id"/>
		<result property="name" column="name"/>
		<result property="type" column="type"/>
		<result property="fcu" column="fcu"/>
		<result property="fcd" column="fcd"/>
		<result property="lcu" column="lcu"/>
		<result property="lcd" column="lcd"/>
		<collection property="componentVoList"  ofType="codedriver.framework.process.dto.ProcessMatrixFormComponentVo">
			<result property="formVersionUuid" column="formVersionUuid"/>
			<result property="formAttributeLabel" column="formAttributeLabel"/>
			<result property="formAttributeUuid" column="formAttributeUuid"/>
			<result property="formName" column="formName"/>
			<result property="formUuid" column="formUuid"/>
			<result property="version" column="version"/>
		</collection>
		<collection property="dispatcherVoList" ofType="codedriver.framework.process.dto.ProcessMatrixDispatcherVo">
			<result property="processUuid" column="processUuid"/>
			<result property="processName" column="processName"/>
			<result property="dispatcherName" column="dispatcherName"/>
		</collection>
	</resultMap>

	<insert id="insertMatrix" parameterType="codedriver.framework.process.dto.ProcessMatrixVo" >
		<selectKey keyProperty="id" resultType="java.lang.Long" order="AFTER">
			select LAST_INSERT_ID() as id
		</selectKey>
		INSERT INTO `process_matrix` (
		`uuid`,
		`name`,
		`type`,
		`fcu`,
		`fcd`,
		`lcu`,
		`lcd`
		) VALUES (
		#{uuid},
		#{name},
		#{type},
		#{fcu},
		NOW(),
		#{lcu},
		NOW()
		)
	</insert>

	<insert id="insertMatrixFormComponent" parameterType="codedriver.framework.process.dto.ProcessMatrixFormComponentVo">
		INSERT INTO `process_matrix_form_component` (
		`form_version_uuid`,
		`matrix_uuid`,
		`form_attribute_uuid`,
		`form_attribute_label`
		) VALUES (
		#{formVersionUuid},
		#{matrixUuid},
		#{formAttributeUuid},
		#{formAttributeLabel}
		)
	</insert>

	<insert id="insertMatrixDispatcher" parameterType="codedriver.framework.process.dto.ProcessMatrixDispatcherVo">
		INSERT INTO `process_matrix_dispatcher` (
		`process_uuid`,
		`matrix_uuid`,
		`dispatcher_name`
		) VALUES (
		#{processUuid},
		#{matrixUuid},
		#{dispatcherName}
		)
	</insert>

	<select id="searchMatrixCount" parameterType="codedriver.framework.process.dto.ProcessMatrixVo" resultType="int">
		SELECT
			COUNT(`uuid`)
		FROM `process_matrix`
		<where>
			<if test="keyword != null and keyword != ''">
				AND `name` LIKE CONCAT('%', #{keyword}, '%')
			</if>
		</where>
	</select>

	<select id="getMatrixByUuid" parameterType="String" resultType="codedriver.framework.process.dto.ProcessMatrixVo">
		SELECT
		`id`,
		`uuid`,
		`name`,
		`type`,
		`fcu`,
		`fcd`,
		`lcu`,
		`lcd`
		FROM `process_matrix`
		WHERE `uuid` = #{uuid}
	</select>

	<select id="getMatrixByName" parameterType="String" resultType="codedriver.framework.process.dto.ProcessMatrixVo">
		SELECT
		`id`,
		`uuid`,
		`name`,
		`type`,
		`fcu`,
		`fcd`,
		`lcu`,
		`lcd`
		FROM `process_matrix`
		WHERE `name` = #{name}
	</select>

	<select id="searchMatrix" parameterType="codedriver.framework.process.dto.ProcessMatrixVo" resultMap="matrixMap">
		SELECT
		a.`id`,
		a.`uuid`,
		a.`name`,
		a.`type`,
		a.`fcu`,
		a.`fcd`,
		a.`lcu`,
		a.`lcd`,
		c.`name` as `processName`,
		b.`process_uuid` as `processUuid`,
		b.`dispatcher_name` as `dispatcherName`,
		d.`form_attribute_label` as `formAttributeLabel`,
		d.`form_attribute_uuid` as `formAttributeUuid`,
		d.`form_version_uuid` as `formVersionUuid`,
		e.`version`,
		f.`name` as `formName`,
		e.`form_uuid` as `formUuid`
		FROM (
				SELECT *
				FROM `process_matrix`
				<where>
					<if test="keyword != null and keyword != ''">
						AND `name` LIKE CONCAT('%', #{keyword}, '%')
					</if>
				</where>
				ORDER BY `id` ASC
				<if test="needPage == true">
					LIMIT #{startNum}, #{pageSize}
				</if>
				) a
		LEFT JOIN `process_matrix_dispatcher` b ON a.`uuid` = b.`matrix_uuid`
		LEFT JOIN `process` c ON b.`process_uuid` = c.`uuid`
		LEFT JOIN `process_matrix_form_component` d ON a.`uuid` = d.`matrix_uuid`
		LEFT JOIN `form_version` e ON d.`form_version_uuid` = e.`uuid`
		LEFT JOIN `form` f ON e.`form_uuid` = f. `uuid`
	</select>

	<update id="updateMatrixNameAndLcu" parameterType="codedriver.framework.process.dto.ProcessMatrixVo">
		UPDATE `process_matrix` SET
		 `name` = #{name},
		 `lcu` = #{lcu},
		 `lcd` = NOW()
		 WHERE `uuid` = #{uuid}
	</update>

	<delete id="deleteMatrixByUuid" parameterType="string">
		DELETE FROM`process_matrix` WHERE `uuid` = #{uuid}
	</delete>
</mapper>