<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="codedriver.framework.process.dao.mapper.MatrixAttributeMapper">
	<select id="getMatrixAttributeByMatrixUuid" parameterType="string" resultType="codedriver.framework.process.dto.ProcessMatrixAttributeVo">
		SELECT
		`uuid`,
		`matrix_uuid` AS matrixUuid,
		`name`,
		`type`,
		`is_required` AS isRequired,
		`sort`,
		`config`
		FROM `process_matrix_attribute`
		WHERE `matrix_uuid` = #{matrixUuid}
		ORDER BY `id`
	</select>
	
	<select id="getMatrixAttributeByMatrixUuidList" parameterType="java.util.List" resultType="codedriver.framework.process.dto.ProcessMatrixAttributeVo">
		SELECT
		`uuid`,
		`matrix_uuid` as matrixUuid,
		`name`,
		`type`,
		`is_required` AS isRequired,
		`sort`,
		`config`
		FROM `process_matrix_attribute`
		<where>
			`matrix_uuid` = #{matrixUuid}
			<if test="columnList != null and columnList.size() > 0">
				and uuid in
				<foreach collection="columnList" open="(" close=")" item="data" separator=",">
					#{data}
				</foreach>
			</if>
		</where>
	</select>

	<select id="checkMatrixAttributeTableExist" parameterType="string" resultType="int">
		SELECT COUNT(`table_name`) FROM information_schema.TABLES WHERE table_name = #{tableName} limit 1
	</select>

	<delete id="deleteAttributeByMatrixUuid" parameterType="string">
		DELETE FROM `process_matrix_attribute` WHERE `matrix_uuid` = #{matrixUuid}
	</delete>

	<insert id="insertMatrixAttribute" parameterType="codedriver.framework.process.dto.ProcessMatrixAttributeVo">
		INSERT INTO
		`process_matrix_attribute` (
			`matrix_uuid`,
			`uuid`,
			`name`,
			`type`,
			`is_required`,
			`sort`,
			`config`
		) VALUES (
			#{matrixUuid},
			#{uuid},
			#{name},
			#{type},
			#{isRequired},
			#{sort},
			#{config}
		)
	</insert>

	<update id="createMatrixDynamicTable">
		CREATE table matrix_${matrixUuid} (
		`id` bigint(20) NOT NULL AUTO_INCREMENT,
		`uuid` char(32) NOT NULL,
		<foreach collection="attributeList" item="attribute" separator="," index="index">
			`${attribute.uuid}` varchar(100) DEFAULT NULL
		</foreach>
		,PRIMARY KEY (`uuid`),
		KEY `id`(`id`)
		)ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8

	</update>

	<update id="dropMatrixDynamicTable" parameterType="string">
		DROP TABLE matrix_${matrixUuid}
	</update>

	<update id="addMatrixDynamicTableColumn">
		ALTER TABLE matrix_${matrixUuid} ADD COLUMN `${columnName}` VARCHAR(100)
	</update>

	<update id="dropMatrixDynamicTableColumn">
		ALTER TABLE matrix_${matrixUuid} DROP COLUMN `${columnName}`
	</update>
</mapper>